<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="style.css" rel="stylesheet">
    <title>MYManager</title>
    <style>
        .form-container {
            display: none;
        }
        .form-container.active {
            display: block;
        }
        .delete-button {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Gestionnaire des employés</h1>

    <label for="form-selector">Sélectionner un formulaire :</label>
    <select id="form-selector">
        <option value="">Choisir un formulaire</option>
        <option value="employee">Employé</option>
        <option value="department">Département</option>
        <option value="position">Poste</option>
        <option value="salary">Salaire</option>
        <option value="project">Projet</option>
        <option value="employee-project">Affectation Employé-Projet</option>
        <option value="attendance">Présence</option>
    </select>

    <div id="employee-form" class="form-container">
        <h2>Ajouter un nouvel employé</h2>
        <form class="data-form">
            <label for="first-name">Prénom:</label>
            <input type="text" id="first-name" name="first_name" required>
            <br>
            <label for="last-name">Nom:</label>
            <input type="text" id="last-name" name="last_name" required>
            <br>
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>
            <br>
            <label for="phone-number">Numéro de téléphone:</label>
            <input type="tel" id="phone-number" name="phone_number" required>
            <br>
            <label for="hire-date">Date d'embauche:</label>
            <input type="date" id="hire-date" name="hire_date" required>
            <br>
            <label for="salary">Salaire:</label>
            <input type="number" id="salary" name="salary" required>
            <br>
            <label for="department">Département:</label>
            <select id="department" name="department_id" required>
            </select>
            <br>
            <label for="position">Poste:</label>
            <select id="position" name="position_id" required>
            </select>
            <br>
            <button type="submit">Ajouter Employé</button>
        </form>

        <h2>Filtrer les employés</h2>
        <div id="filter-container">
            <form id="filter-department-form">
                <label for="filter-department">Filtrer par département:</label>
                <select id="filter-department" name="department_id">
                </select>
                <button type="submit">Filtrer</button>
            </form>

            <form id="filter-position-form">
                <label for="filter-position">Filtrer par poste:</label>
                <select id="filter-position" name="position_id">
                </select>
                <button type="submit">Filtrer</button>
            </form>
        </div>
    </div>

    <div id="department-form" class="form-container">
        <h2>Ajouter un nouveau département</h2>
        <form class="data-form">
            <label for="department-name">Nom du département:</label>
            <input type="text" id="department-name" name="department_name" required>
            <br>
            <label for="manager-id">ID du manager:</label>
            <input type="number" id="manager-id" name="manager_id" required>
            <br>
            <button type="submit">Ajouter Département</button>
        </form>

        <h2>Filtrer les départements</h2>
        <div id="filter-container">
            <form id="filter-department-name-form">
                <label for="filter-department-name">Filtrer par nom:</label>
                <input type="text" id="filter-department-name" name="department_name" required>
                <button type="submit">Filtrer</button>
            </form>

            <form id="filter-manager-id-form">
                <label for="filter-manager-id">Filtrer par ID du manager:</label>
                <input type="number" id="filter-manager-id" name="manager_id" required>
                <button type="submit">Filtrer</button>
            </form>
        </div>
    </div>

    <div id="position-form" class="form-container">
        <h2>Ajouter un nouveau poste</h2>
        <form class="data-form">
            <label for="position-name">Nom du poste:</label>
            <input type="text" id="position-name" name="position_name" required>
            <br>
            <label for="salary-range">Fourchette de salaire:</label>
            <input type="text" id="salary-range" name="salary_range" required>
            <br>
            <button type="submit">Ajouter Poste</button>
        </form>

        <h2>Filtrer les postes</h2>
        <div id="filter-container">
            <form id="filter-position-name-form">
                <label for="filter-position-name">Filtrer par nom:</label>
                <input type="text" id="filter-position-name" name="position_name" required>
                <button type="submit">Filtrer</button>
            </form>

            <form id="filter-salary-range-form">
                <label for="filter-salary-range">Filtrer par fourchette de salaire:</label>
                <input type="text" id="filter-salary-range" name="salary_range" required>
                <button type="submit">Filtrer</button>
            </form>
        </div>
    </div>

    <div id="salary-form" class="form-container">
        <h2>Ajouter un nouveau salaire</h2>
        <form class="data-form">
            <label for="salary-employee-id">ID de l'employé:</label>
            <input type="number" id="salary-employee-id" name="employee_id" required>
            <br>
            <label for="salary-amount">Montant:</label>
            <input type="number" id="salary-amount" name="amount" step="0.01" required>
            <br>
            <label for="effective-date">Date d'effet:</label>
            <input type="date" id="effective-date" name="effective_date" required>
            <br>
            <button type="submit">Ajouter Salaire</button>
        </form>

        <h2>Filtrer les salaires</h2>
        <div id="filter-container">
            <form id="filter-salary-amount-form">
                <label for="filter-salary-amount-min">Montant minimum:</label>
                <input type="number" id="filter-salary-amount-min" name="min" required>
                <br>
                <label for="filter-salary-amount-max">Montant maximum:</label>
                <input type="number" id="filter-salary-amount-max" name="max" required>
                <button type="submit">Filtrer</button>
            </form>

            <form id="filter-salary-date-form">
                <label for="filter-salary-date">Filtrer par date d'effet:</label>
                <input type="date" id="filter-salary-date" name="effective_date" required>
                <button type="submit">Filtrer</button>
            </form>
        </div>
    </div>

    <div id="project-form" class="form-container">
        <h2>Ajouter un nouveau projet</h2>
        <form class="data-form">
            <label for="project-name">Nom du projet:</label>
            <input type="text" id="project-name" name="project_name" required>
            <br>
            <label for="start-date">Date de début:</label>
            <input type="date" id="start-date" name="start_date" required>
            <br>
            <label for="end-date">Date de fin:</label>
            <input type="date" id="end-date" name="end_date" required>
            <br>
            <label for="project-department">Département:</label>
            <select id="project-department" name="department_id" required>
            </select>
            <br>
            <button type="submit">Ajouter Projet</button>
        </form>

        <h2>Filtrer les projets</h2>
        <div id="filter-container">
            <form id="filter-project-department-form">
                <label for="filter-project-department">Filtrer par département:</label>
                <select id="filter-project-department" name="department_id">
                </select>
                <button type="submit">Filtrer</button>
            </form>

            <form id="filter-project-start-date-form">
                <label for="filter-project-start-date">Filtrer par date de début:</label>
                <input type="date" id="filter-project-start-date" name="start_date" required>
                <button type="submit">Filtrer</button>
            </form>
        </div>
    </div>

    <div id="employee-project-form" class="form-container">
        <h2>Ajouter une affectation employé-projet</h2>
        <form class="data-form">
            <label for="ep-employee-id">ID de l'employé:</label>
            <input type="number" id="ep-employee-id" name="employee_id" required>
            <br>
            <label for="ep-project-id">ID du projet:</label>
            <input type="number" id="ep-project-id" name="project_id" required>
            <br>
            <label for="assignment-date">Date d'affectation:</label>
            <input type="date" id="assignment-date" name="assignment_date" required>
            <br>
            <button type="submit">Ajouter Affectation</button>
        </form>

        <h2>Filtrer les affectations</h2>
        <div id="filter-container">
            <form id="filter-employee-project-employee-form">
                <label for="filter-employee-project-employee">Filtrer par ID de l'employé:</label>
                <input type="number" id="filter-employee-project-employee" name="employee_id" required>
                <button type="submit">Filtrer</button>
            </form>

            <form id="filter-employee-project-project-form">
                <label for="filter-employee-project-project">Filtrer par ID du projet:</label>
                <input type="number" id="filter-employee-project-project" name="project_id" required>
                <button type="submit">Filtrer</button>
            </form>
        </div>
    </div>

    <div id="attendance-form" class="form-container">
        <h2>Ajouter une présence</h2>
        <form class="data-form">
            <label for="attendance-employee-id">ID de l'employé:</label>
            <input type="number" id="attendance-employee-id" name="employee_id" required>
            <br>
            <label for="attendance-date">Date:</label>
            <input type="date" id="attendance-date" name="date" required>
            <br>
            <label for="attendance-status">Statut:</label>
            <select id="attendance-status" name="status" required>
                <option value="present">Présent</option>
                <option value="absent">Absent</option>
                <option value="late">En retard</option>
                <option value="on_leave">En congé</option>
            </select>
            <br>
            <button type="submit">Ajouter Présence</button>
        </form>

        <h2>Filtrer les présences</h2>
        <div id="filter-container">
            <form id="filter-attendance-status-form">
                <label for="filter-attendance-status">Filtrer par statut:</label>
                <select id="filter-attendance-status" name="status">
                    <option value="present">Présent</option>
                    <option value="absent">Absent</option>
                    <option value="late">En retard</option>
                    <option value="on_leave">En congé</option>
                </select>
                <button type="submit">Filtrer</button>
            </form>

            <form id="filter-attendance-date-form">
                <label for="filter-attendance-date">Filtrer par date:</label>
                <input type="date" id="filter-attendance-date" name="date" required>
                <button type="submit">Filtrer</button>
            </form>
        </div>
    </div>

    <h2>Tables de la base de données</h2>
    <div id="tables-container"></div>

    <script>
        function loadDepartmentsAndPositions() {
            fetch('/departments')
                .then(response => response.json())
                .then(data => {
                    const departmentSelects = document.querySelectorAll('#department, #project-department, #filter-department, #filter-project-department');
                    departmentSelects.forEach(select => {
                        data.forEach(dept => {
                            const option = document.createElement('option');
                            option.value = dept.department_id;
                            option.textContent = dept.department_name;
                            select.appendChild(option);
                        });
                    });
                });

            fetch('/positions')
                .then(response => response.json())
                .then(data => {
                    const positionSelects = document.querySelectorAll('#position, #filter-position');
                    positionSelects.forEach(select => {
                        data.forEach(pos => {
                            const option = document.createElement('option');
                            option.value = pos.position_id;
                            option.textContent = pos.position_name;
                            select.appendChild(option);
                        });
                    });
                });
        }

        loadDepartmentsAndPositions();

        fetch('/tables')
            .then(response => response.json())
            .then(data => {
                const tablesContainer = document.getElementById('tables-container');
                data.tables.forEach(tableData => {
                    const tableTitle = document.createElement('h3');
                    tableTitle.textContent = tableData.table;
                    tablesContainer.appendChild(tableTitle);

                    const tableElement = document.createElement('table');
                    const thead = document.createElement('thead');
                    const tbody = document.createElement('tbody');

                    if (tableData.rows.length > 0) {
                        const headers = Object.keys(tableData.rows[0]);
                        const headerRow = document.createElement('tr');
                        headers.forEach(header => {
                            const th = document.createElement('th');
                            th.textContent = header;
                            headerRow.appendChild(th);
                        });
                        const th = document.createElement('th');
                        th.textContent = 'Actions';
                        headerRow.appendChild(th);
                        thead.appendChild(headerRow);
                    }

                    tableData.rows.forEach(row => {
                        const rowElement = document.createElement('tr');
                        Object.values(row).forEach(value => {
                            const td = document.createElement('td');
                            td.textContent = value;
                            rowElement.appendChild(td);
                        });
                        const td = document.createElement('td');
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Supprimer';
                        deleteButton.classList.add('delete-button');
                        deleteButton.addEventListener('click', () => deleteRow(tableData.table, row[Object.keys(row)[0]]));
                        td.appendChild(deleteButton);
                        rowElement.appendChild(td);
                        tbody.appendChild(rowElement);
                    });

                    tableElement.appendChild(thead);
                    tableElement.appendChild(tbody);
                    tablesContainer.appendChild(tableElement);
                });
            })
            .catch(error => console.error('Error fetching tables:', error));

        function deleteRow(table, id) {
            fetch(`/delete/${table}/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    location.reload();
                } else {
                    console.error('Error deleting row:', result.error);
                }
            })
            .catch(error => console.error('Error deleting row:', error));
        }

        document.querySelectorAll('.data-form').forEach(form => {
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());
                const endpoint = '/' + this.closest('.form-container').id.replace('-form', '');
                fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    console.log('Data added:', result);
                    location.reload();
                })
                .catch(error => console.error('Error adding data:', error));
            });
        });

        document.getElementById('form-selector').addEventListener('change', function() {
            document.querySelectorAll('.form-container').forEach(container => {
                container.classList.remove('active');
            });
            const selectedForm = document.getElementById(this.value + '-form');
            if (selectedForm) {
                selectedForm.classList.add('active');
            }
        });

        document.getElementById('filter-department-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const departmentId = document.getElementById('filter-department').value;
            fetch(`/employees/department/${departmentId}`)
                .then(response => response.json())
                .then(data => displayFilteredEmployees(data))
                .catch(error => console.error('Error fetching filtered employees:', error));
        });

        document.getElementById('filter-position-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const positionId = document.getElementById('filter-position').value;
            fetch(`/employees/position/${positionId}`)
                .then(response => response.json())
                .then(data => displayFilteredEmployees(data))
                .catch(error => console.error('Error fetching filtered employees:', error));
        });

        document.getElementById('filter-salary-amount-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const minSalary = document.getElementById('filter-salary-amount-min').value;
            const maxSalary = document.getElementById('filter-salary-amount-max').value;
            fetch(`/salaries/amount/${minSalary}/${maxSalary}`)
                .then(response => response.json())
                .then(data => displayFilteredSalaries(data))
                .catch(error => console.error('Error fetching filtered salaries:', error));
        });

        document.getElementById('filter-salary-date-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const effectiveDate = document.getElementById('filter-salary-date').value;
            fetch(`/salaries/date/${effectiveDate}`)
                .then(response => response.json())
                .then(data => displayFilteredSalaries(data))
                .catch(error => console.error('Error fetching filtered salaries:', error));
        });

        document.getElementById('filter-project-department-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const departmentId = document.getElementById('filter-project-department').value;
            fetch(`/projects/department/${departmentId}`)
                .then(response => response.json())
                .then(data => displayFilteredProjects(data))
                .catch(error => console.error('Error fetching filtered projects:', error));
        });

        document.getElementById('filter-project-start-date-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const startDate = document.getElementById('filter-project-start-date').value;
            fetch(`/projects/start_date/${startDate}`)
                .then(response => response.json())
                .then(data => displayFilteredProjects(data))
                .catch(error => console.error('Error fetching filtered projects:', error));
        });

        document.getElementById('filter-employee-project-employee-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const employeeId = document.getElementById('filter-employee-project-employee').value;
            fetch(`/employee-projects/employee/${employeeId}`)
                .then(response => response.json())
                .then(data => displayFilteredEmployeeProjects(data))
                .catch(error => console.error('Error fetching filtered employee projects:', error));
        });

        document.getElementById('filter-employee-project-project-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const projectId = document.getElementById('filter-employee-project-project').value;
            fetch(`/employee-projects/project/${projectId}`)
                .then(response => response.json())
                .then(data => displayFilteredEmployeeProjects(data))
                .catch(error => console.error('Error fetching filtered employee projects:', error));
        });

        document.getElementById('filter-attendance-status-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const status = document.getElementById('filter-attendance-status').value;
            fetch(`/attendance/status/${status}`)
                .then(response => response.json())
                .then(data => displayFilteredAttendance(data))
                .catch(error => console.error('Error fetching filtered attendance:', error));
        });

        document.getElementById('filter-attendance-date-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const date = document.getElementById('filter-attendance-date').value;
            fetch(`/attendance/date/${date}`)
                .then(response => response.json())
                .then(data => displayFilteredAttendance(data))
                .catch(error => console.error('Error fetching filtered attendance:', error));
        });

        function displayFilteredEmployees(employees) {
            displayFilteredData(employees, 'Filtered Employees');
        }

        function displayFilteredSalaries(salaries) {
            displayFilteredData(salaries, 'Filtered Salaries');
        }

        function displayFilteredProjects(projects) {
            displayFilteredData(projects, 'Filtered Projects');
        }

        function displayFilteredEmployeeProjects(employeeProjects) {
            displayFilteredData(employeeProjects, 'Filtered Employee Projects');
        }

        function displayFilteredAttendance(attendance) {
            displayFilteredData(attendance, 'Filtered Attendance');
        }

        function displayFilteredData(data, title) {
            const tablesContainer = document.getElementById('tables-container');
            tablesContainer.innerHTML = ''; 

            const tableTitle = document.createElement('h3');
            tableTitle.textContent = title;
            tablesContainer.appendChild(tableTitle);

            const tableElement = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            if (data.length > 0) {
                const headers = Object.keys(data[0]);
                const headerRow = document.createElement('tr');
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
            }

            data.forEach(item => {
                const rowElement = document.createElement('tr');
                Object.values(item).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    rowElement.appendChild(td);
                });
                tbody.appendChild(rowElement);
            });

            tableElement.appendChild(thead);
            tableElement.appendChild(tbody);
            tablesContainer.appendChild(tableElement);
        }
    </script>
</body>
</html>
